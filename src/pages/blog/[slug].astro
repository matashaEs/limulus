---
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";
import type { GetStaticPaths } from "astro";
import type { BlogPost } from "../../types/blog";

const formatDate = (d: Date) =>
  d.toLocaleDateString("uk-UA", { year: "numeric", month: "long" });

const readingTime = (text: string, wpm = 200) =>
  Math.max(1, Math.round(text.trim().split(/\s+/).length / wpm));

// генеруємо шляхи і підсовуємо сусідів
export const getStaticPaths: GetStaticPaths = async () => {
  const posts: BlogPost[] = (
    await getCollection<"blog">("blog", (e: BlogPost) => !e.data.draft)
  ).sort(
    (a: BlogPost, b: BlogPost) =>
      b.data.pubDate.getTime() - a.data.pubDate.getTime()
  );

  return posts.map((post, i) => ({
    params: { slug: post.slug },
    props: { post, prev: posts[i + 1] ?? null, next: posts[i - 1] ?? null },
  }));
};

const { post, prev, next } = Astro.props as {
  post: BlogPost;
  prev: BlogPost | null;
  next: BlogPost | null;
};

const { Content } = await post.render();
const pubISO = post.data.pubDate.toISOString();
const pubHuman = formatDate(post.data.pubDate);
const minutes = readingTime(post.body);
---

<Layout title={post.data.title} description={post.data.description}>
  <section class="post-hero">
    <div class="container post-hero__inner">
      <div class="post-hero__text">
        <a class="back-link" href="/blog/">← Вріз до списку</a>
        <h1 class="post-title">{post.data.title}</h1>
        {
          post.data.description && (
            <p class="post-subtitle">{post.data.description}</p>
          )
        }
      </div>
      {
        post.data.heroImage && (
          <div class="post-hero__image">
            <img
              src={post.data.heroImage}
              alt={post.data.imageAlt ?? post.data.title}
            />
          </div>
        )
      }
    </div>
  </section>

  <!-- BODY + SIDEBAR -->
  <section class="container post-body">
    <div class="post-main">
      <p class="post-meta">
        <time datetime={pubISO}>{pubHuman}</time>
        <span class="dot">•</span>
        <span>Час читання: {minutes} хв</span>
      </p>

      <article class="post-content">
        <Content />
      </article>
    </div>

    <aside class="post-aside">
      {
        next && (
          <a class="aside-card" href={`/blog/${next.slug}/`}>
            <span class="aside-label">Наступний пост</span>
            <h3>{next.data.title}</h3>
            {next.data.description && <p>{next.data.description}</p>}
          </a>
        )
      }
      {
        prev && (
          <a class="aside-card" href={`/blog/${prev.slug}/`}>
            <span class="aside-label">Попередній пост</span>
            <h3>{prev.data.title}</h3>
            {prev.data.description && <p>{prev.data.description}</p>}
          </a>
        )
      }
    </aside>
  </section>
</Layout>
